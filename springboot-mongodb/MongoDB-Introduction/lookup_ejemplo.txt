---

## **Â¿QuÃ© hace `$lookup`?**  
La operaciÃ³n `$lookup` actÃºa como un `LEFT JOIN` en SQL.  
```json
{
  "$lookup": {
    "from": "customers",
    "localField": "customerId",
    "foreignField": "customerId",
    "as": "customer"
  }
}
```
- `from: "customers"` â†’ Se une con la colecciÃ³n `customers`.  
- `localField: "customerId"` â†’ Se usa el campo `customerId` de `orders`.  
- `foreignField: "customerId"` â†’ Se busca el mismo campo en `customers`.  
- `as: "customer"` â†’ El resultado de la uniÃ³n se almacena en un array llamado `customer`.  

ğŸš¨ **DespuÃ©s de este paso, la estructura del documento cambia asÃ­:**  
```json
{
  "orderId": 3,
  "customerId": "11223344",
  "items": [
    {
      "name": "GPU NVIDIA RTX 3070",
      "quantity": 1,
      "price": 500
    }
  ],
  "total": 500,
  "status": "Pending",
  "customer": [
    {
      "customerId": "11223344",
      "name": "Juan PÃ©rez",
      "email": "juan@example.com"
    }
  ]
}
```
ğŸ“Œ **Importante:** `customer` es ahora un **array**, aunque haya solo un cliente.

---

## **Â¿Por quÃ© `$unwind`?**  
Como `$lookup` devuelve un **array**, `$unwind` convierte ese array en un objeto plano.  
```json
{
  "$unwind": "$customer"
}
```
ğŸ”¹ Esto transforma:  
```json
{
  "customer": [
    {
      "customerId": "11223344",
      "name": "Juan PÃ©rez",
      "email": "juan@example.com"
    }
  ]
}
```
â¡ **En esto** (sin array):  
```json
{
  "customer": {
    "customerId": "11223344",
    "name": "Juan PÃ©rez",
    "email": "juan@example.com"
  }
}
```
Esto facilita acceder a los datos directamente en los siguientes pasos.

---

## **Â¿QuÃ© hace `$project`?**  
Este paso selecciona los campos que queremos en la salida.  
```json
{
  "$project": { 
    "_id": 0, 
    "orderId": 1, 
    "customer.name": 1, 
    "customer.email": 1, 
    "items": 1, 
    "total": 1
  }
}
```
- `"_id": 0` â†’ Oculta el campo `_id` por defecto.  
- `"orderId": 1` â†’ Muestra el `orderId`.  
- `"customer.name": 1` â†’ Solo mantiene `name` de `customer`.  
- `"customer.email": 1` â†’ Solo mantiene `email` de `customer`.  
- `"items": 1, "total": 1` â†’ Mantiene `items` y `total`.  

âœ **Transforma el documento en:**  
```json
{
  "orderId": 3,
  "customer": {
    "name": "Juan PÃ©rez",
    "email": "juan@example.com"
  },
  "items": [
    {
      "name": "GPU NVIDIA RTX 3070",
      "quantity": 1,
      "price": 500
    }
  ],
  "total": 500
}
```
ğŸ¯ **Ya no tienes `customerId`, solo el nombre y correo del cliente**.

---

## **Resumen de la Consulta Completa**
```json
db.orders.aggregate([
  { "$match": { "items.name": "GPU NVIDIA RTX 3070" } },
  { "$lookup": {
      "from": "customers",
      "localField": "customerId",
      "foreignField": "customerId",
      "as": "customer"
    }
  },
  { "$unwind": "$customer" },
  { "$project": { 
      "_id": 0, 
      "orderId": 1, 
      "customer.name": 1, 
      "customer.email": 1, 
      "items": 1, 
      "total": 1
    }
  }
])
```

### **ğŸ“Œ Paso a paso**
1ï¸âƒ£ **Filtra** los pedidos con la GPU RTX 3070 (`$match`).  
2ï¸âƒ£ **Une** con la colecciÃ³n `customers` (`$lookup`).  
3ï¸âƒ£ **Transforma el array `customer` en objeto** (`$unwind`).  
4ï¸âƒ£ **Elimina `_id` y selecciona solo los campos necesarios** (`$project`).  

ğŸ’¡ **Ahora puedes ver fÃ¡cilmente quÃ© clientes compraron la GPU RTX 3070.**  
**Â¿Te queda mÃ¡s claro o quieres otro ejemplo?** ğŸš€